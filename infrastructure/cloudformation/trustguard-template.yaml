AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: TrustGuard - Zero Trust Security for Nigerian Informal E-commerce

# ============================================================
# PARAMETERS: Configuration for deployment flexibility
# ============================================================
Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues: [dev, prod]
    Description: Deployment environment (dev or prod)
  
  HighValueThreshold:
    Type: Number
    Default: 1000000
    Description: Order amount threshold (₦) for CEO escalation (default ₦1,000,000)
  
  BucketNamePrefix:
    Type: String
    Default: trustguard-receipts
    Description: Prefix for S3 receipt bucket name
  
  AlertEmail:
    Type: String
    Default: ""
    Description: Email address for CloudWatch alarm notifications (leave empty to skip)

# ============================================================
# GLOBALS: Common configuration for all Lambda functions
# ============================================================
Globals:
  Function:
    Runtime: python3.11
    MemorySize: 512
    Timeout: 30
    Environment:
      Variables:
        ENV: !Ref Environment
        HIGH_VALUE_THRESHOLD: !Ref HighValueThreshold
        ENVIRONMENT: !Ref Environment
        STACK_NAME: !Ref AWS::StackName
        META_SECRET_NAME: !Sub "/TrustGuard/${Environment}/meta-${AWS::StackName}"
        META_WEBHOOK_VERIFY_TOKEN: "test_trustgu@rd_25"
  Api:
    # Disable AWS_IAM authorization - we handle JWT authentication in Lambda
    Auth:
      DefaultAuthorizer: NONE

# ============================================================
# CONDITIONS: Conditional resource creation
# ============================================================
Conditions:
  HasAlertEmail: !Not [!Equals [!Ref AlertEmail, ""]]

# ============================================================
# RESOURCES: Infrastructure components
# ============================================================
Resources:

  # ========== KMS KEY (Customer Managed) ==========
  # Zero Trust: Encrypt everything with customer-managed key
  TrustGuardKMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: Customer-managed key for encrypting receipts, DynamoDB tables, and secrets
      EnableKeyRotation: true
      PendingWindowInDays: 7
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Sid: Enable IAM Root Permissions
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action: "kms:*"
            Resource: "*"
          
          - Sid: Allow Lambda Service
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action:
              - "kms:Encrypt"
              - "kms:Decrypt"
              - "kms:GenerateDataKey"
              - "kms:DescribeKey"
            Resource: "*"
          
          - Sid: Allow DynamoDB Service
            Effect: Allow
            Principal:
              Service: dynamodb.amazonaws.com
            Action:
              - "kms:Decrypt"
              - "kms:DescribeKey"
              - "kms:CreateGrant"
            Resource: "*"
            Condition:
              StringEquals:
                "kms:ViaService": !Sub "dynamodb.${AWS::Region}.amazonaws.com"
          
          - Sid: Allow S3 Service
            Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action:
              - "kms:Decrypt"
              - "kms:GenerateDataKey"
            Resource: "*"

  TrustGuardKMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/trustguard-${Environment}"
      TargetKeyId: !Ref TrustGuardKMSKey

  # ========== SECRETS MANAGER ==========
  # Zero Trust: Never hardcode secrets
  TrustGuardSecrets:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "/TrustGuard/${Environment}/app-${AWS::StackName}"
      Description: JWT secret and application secrets
      KmsKeyId: !Ref TrustGuardKMSKey
      GenerateSecretString:
        SecretStringTemplate: "{}"
        GenerateStringKey: "JWT_SECRET"
        PasswordLength: 32
        ExcludePunctuation: true

  TrustGuardMetaSecrets:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "/TrustGuard/${Environment}/meta-${AWS::StackName}"
      Description: Meta WhatsApp/Instagram API credentials (APP_ID, APP_SECRET, tokens per CEO)
      KmsKeyId: !Ref TrustGuardKMSKey
      SecretString: '{"APP_ID":"","APP_SECRET":""}'

  # ========== DYNAMODB TABLES ==========
  
  # Users Table: Stores Buyers, Vendors, CEOs
  TrustGuardUsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "TrustGuard-Users-${Environment}"
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: ceo_id
          AttributeType: S
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: ByCEOID
          KeySchema:
            - AttributeName: ceo_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !Ref TrustGuardKMSKey
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true

  # OTPs Table: Time-limited OTP codes with TTL
  TrustGuardOTPsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "TrustGuard-OTPs-${Environment}"
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: request_id
          AttributeType: S
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
        - AttributeName: request_id
          KeyType: RANGE
      TimeToLiveSpecification:
        AttributeName: expires_at
        Enabled: true
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !Ref TrustGuardKMSKey

  # Audit Logs Table: Immutable security event logs
  TrustGuardAuditLogsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "TrustGuard-AuditLogs-${Environment}"
      AttributeDefinitions:
        - AttributeName: log_id
          AttributeType: S
        - AttributeName: actor_id
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: N
      KeySchema:
        - AttributeName: log_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: ByActor
          KeySchema:
            - AttributeName: actor_id
              KeyType: HASH
            - AttributeName: timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !Ref TrustGuardKMSKey
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true

  # Orders Table: Transaction and receipt metadata
  TrustGuardOrdersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "TrustGuard-Orders-${Environment}"
      AttributeDefinitions:
        - AttributeName: order_id
          AttributeType: S
        - AttributeName: vendor_id
          AttributeType: S
        - AttributeName: ceo_id
          AttributeType: S
      KeySchema:
        - AttributeName: order_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: ByVendorAndCEO
          KeySchema:
            - AttributeName: vendor_id
              KeyType: HASH
            - AttributeName: ceo_id
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !Ref TrustGuardKMSKey
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true

  # Escalations Table: High-value/flagged transactions requiring CEO approval
  TrustGuardEscalationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "TrustGuard-Escalations-${Environment}"
      AttributeDefinitions:
        - AttributeName: escalation_id
          AttributeType: S
        - AttributeName: ceo_id
          AttributeType: S
        - AttributeName: status
          AttributeType: S
      KeySchema:
        - AttributeName: escalation_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: ByCEOPending
          KeySchema:
            - AttributeName: ceo_id
              KeyType: HASH
            - AttributeName: status
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !Ref TrustGuardKMSKey
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true

  # CEO Mapping Table: Maps WhatsApp phone_number_id / Instagram page_id to ceo_id
  TrustGuardCEOMappingTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "TrustGuard-CEOMapping-${Environment}"
      AttributeDefinitions:
        - AttributeName: phone_number_id
          AttributeType: S
        - AttributeName: page_id
          AttributeType: S
      KeySchema:
        - AttributeName: phone_number_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: ByPageID
          KeySchema:
            - AttributeName: page_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !Ref TrustGuardKMSKey

  # Conversation State Table: Multi-turn conversation context for buyers
  TrustGuardConversationStateTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "TrustGuard-ConversationState-${Environment}"
      AttributeDefinitions:
        - AttributeName: buyer_id
          AttributeType: S
      KeySchema:
        - AttributeName: buyer_id
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: expires_at
        Enabled: true
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !Ref TrustGuardKMSKey
      Tags:
        - Key: Purpose
          Value: Conversational-State-Management
        - Key: DataRetention
          Value: Auto-expire-after-1-hour

  # CEO Config Table: Chatbot customization per CEO (greeting, tone, preferences)
  TrustGuardCEOConfigTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "TrustGuard-CEOConfig-${Environment}"
      AttributeDefinitions:
        - AttributeName: ceo_id
          AttributeType: S
      KeySchema:
        - AttributeName: ceo_id
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !Ref TrustGuardKMSKey
      Tags:
        - Key: Purpose
          Value: CEO-Chatbot-Configuration
        - Key: DataSensitivity
          Value: Low

  # Vendor Preferences Table: Auto-approve thresholds, Textract settings
  TrustGuardVendorPreferencesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "TrustGuard-VendorPreferences-${Environment}"
      AttributeDefinitions:
        - AttributeName: vendor_id
          AttributeType: S
      KeySchema:
        - AttributeName: vendor_id
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !Ref TrustGuardKMSKey
      Tags:
        - Key: Purpose
          Value: Vendor-Business-Preferences
        - Key: DataSensitivity
          Value: Low

  # Negotiations Table: Price negotiation workflow before order creation
  TrustGuardNegotiationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "TrustGuard-Negotiations-${Environment}"
      AttributeDefinitions:
        - AttributeName: negotiation_id
          AttributeType: S
        - AttributeName: buyer_id
          AttributeType: S
        - AttributeName: vendor_id
          AttributeType: S
        - AttributeName: status
          AttributeType: S
      KeySchema:
        - AttributeName: negotiation_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: ByBuyer
          KeySchema:
            - AttributeName: buyer_id
              KeyType: HASH
            - AttributeName: status
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: ByVendor
          KeySchema:
            - AttributeName: vendor_id
              KeyType: HASH
            - AttributeName: status
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !Ref TrustGuardKMSKey
      Tags:
        - Key: Purpose
          Value: Price-Negotiation-Workflow
        - Key: DataSensitivity
          Value: Medium

  # ========== S3 BUCKET (Receipts) ==========
  TrustGuardReceiptBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${BucketNamePrefix}-${AWS::AccountId}-${Environment}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref TrustGuardKMSKey
      LifecycleConfiguration:
        Rules:
          - Id: AbortIncompleteMultipartUploads
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7
            Status: Enabled
      VersioningConfiguration:
        Status: Enabled

  # S3 Bucket Policy: Enforce encryption and SSL
  TrustGuardBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref TrustGuardReceiptBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: DenyUnencryptedObjectUploads
            Effect: Deny
            Principal: "*"
            Action: "s3:PutObject"
            Resource: !Sub "${TrustGuardReceiptBucket.Arn}/*"
            Condition:
              StringNotEquals:
                "s3:x-amz-server-side-encryption": "aws:kms"
          
          - Sid: DenyInsecureTransport
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource: 
              - !Sub "${TrustGuardReceiptBucket.Arn}/*"
              - !GetAtt TrustGuardReceiptBucket.Arn
            Condition:
              Bool:
                "aws:SecureTransport": "false"

  EscalationAlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub "TrustGuard-EscalationAlert-${Environment}"
      DisplayName: TrustGuard High-Value Transaction Alerts
      KmsMasterKeyId: !Ref TrustGuardKMSKey

  # SNS Topic for CloudWatch Alarms
  MonitoringAlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub "TrustGuard-Monitoring-${Environment}"
      DisplayName: TrustGuard Production Monitoring Alerts
      Subscription:
        - !If
          - HasAlertEmail
          - Endpoint: !Ref AlertEmail
            Protocol: email
          - !Ref AWS::NoValue

  # ========== CLOUDWATCH ALARMS ==========
  
  # Alarm 1: High Error Rate across all Lambda functions
  HighErrorRateAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlertEmail
    Properties:
      AlarmName: !Sub "TrustGuard-HighErrorRate-${Environment}"
      AlarmDescription: Alert when Lambda error rate exceeds threshold
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300  # 5 minutes
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref MonitoringAlertTopic

  # Alarm 2: OTP Verification Failures (potential attack)
  OTPFailureAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlertEmail
    Properties:
      AlarmName: !Sub "TrustGuard-OTPFailures-${Environment}"
      AlarmDescription: Alert when OTP verification failures spike
      MetricName: OTPVerificationFailures
      Namespace: TrustGuard/Auth
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref MonitoringAlertTopic

  # Alarm 3: Lambda Function Throttling
  LambdaThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlertEmail
    Properties:
      AlarmName: !Sub "TrustGuard-LambdaThrottle-${Environment}"
      AlarmDescription: Alert when Lambda functions are being throttled
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref MonitoringAlertTopic

  # Alarm 4: API Gateway 5xx Errors
  APIGateway5xxAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlertEmail
    Properties:
      AlarmName: !Sub "TrustGuard-API5xxErrors-${Environment}"
      AlarmDescription: Alert when API Gateway returns 5xx errors
      MetricName: 5XXError
      Namespace: AWS/ApiGateway
      Dimensions:
        - Name: ApiName
          Value: !Ref ServerlessRestApi
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref MonitoringAlertTopic

  # Alarm 5: DynamoDB Throttling
  DynamoDBThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlertEmail
    Properties:
      AlarmName: !Sub "TrustGuard-DynamoDBThrottle-${Environment}"
      AlarmDescription: Alert when DynamoDB requests are being throttled
      MetricName: UserErrors
      Namespace: AWS/DynamoDB
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      AlarmActions:
        - !Ref MonitoringAlertTopic

  # ========== IAM ROLE (Least Privilege) ==========
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "TrustGuard-LambdaExecution-${Environment}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !GetAtt TrustGuardUsersTable.Arn
                  - !GetAtt TrustGuardOTPsTable.Arn
                  - !GetAtt TrustGuardAuditLogsTable.Arn
                  - !GetAtt TrustGuardOrdersTable.Arn
                  - !GetAtt TrustGuardEscalationsTable.Arn
                  - !GetAtt TrustGuardCEOMappingTable.Arn
                  - !GetAtt TrustGuardConversationStateTable.Arn
                  - !GetAtt TrustGuardCEOConfigTable.Arn
                  - !GetAtt TrustGuardVendorPreferencesTable.Arn
                  - !GetAtt TrustGuardNegotiationsTable.Arn
                  - !Sub "${TrustGuardUsersTable.Arn}/index/*"
                  - !Sub "${TrustGuardOrdersTable.Arn}/index/*"
                  - !Sub "${TrustGuardEscalationsTable.Arn}/index/*"
                  - !Sub "${TrustGuardCEOMappingTable.Arn}/index/*"
                  - !Sub "${TrustGuardAuditLogsTable.Arn}/index/*"
                  - !Sub "${TrustGuardNegotiationsTable.Arn}/index/*"
        
        - PolicyName: S3Access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:DeleteObject
                Resource: !Sub "${TrustGuardReceiptBucket.Arn}/*"
        
        - PolicyName: KMSAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - kms:GenerateDataKey
                  - kms:Decrypt
                  - kms:Encrypt
                  - kms:DescribeKey
                Resource: !GetAtt TrustGuardKMSKey.Arn
        
        - PolicyName: SecretsManagerAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource:
                  - !Ref TrustGuardSecrets
                  - !Ref TrustGuardMetaSecrets
        
        - PolicyName: SNSPublish
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sns:Publish
                Resource: !Ref EscalationAlertTopic
        
        - PolicyName: CloudWatchMetrics
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: "*"

  # ========== LAMBDA FUNCTIONS ==========
  
  # AuthService: OTP generation and verification
  AuthService:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "TrustGuard-AuthService-${Environment}"
      CodeUri: ../../backend/
      Handler: app.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          JWT_SECRET_ARN: !Ref TrustGuardSecrets
          USERS_TABLE: !Ref TrustGuardUsersTable
          OTPS_TABLE: !Ref TrustGuardOTPsTable
          AUDIT_LOGS_TABLE: !Ref TrustGuardAuditLogsTable
      Events:
        ApiAuth:
          Type: Api
          Properties:
            Path: /auth/{proxy+}
            Method: ANY
            Auth:
              Authorizer: NONE
        ApiWebhooks:
          Type: Api
          Properties:
            Path: /integrations/{proxy+}
            Method: ANY
            Auth:
              Authorizer: NONE

  # VendorService: Vendor dashboard and order management
  VendorService:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "TrustGuard-VendorService-${Environment}"
      CodeUri: ../../backend/
      Handler: app.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          JWT_SECRET_ARN: !Ref TrustGuardSecrets
          ORDERS_TABLE: !Ref TrustGuardOrdersTable
          USERS_TABLE: !Ref TrustGuardUsersTable
          ESCALATIONS_TABLE: !Ref TrustGuardEscalationsTable
          AUDIT_LOGS_TABLE: !Ref TrustGuardAuditLogsTable
          VENDOR_PREFERENCES_TABLE: !Ref TrustGuardVendorPreferencesTable
          ESCALATION_SNS_TOPIC_ARN: !Ref EscalationAlertTopic
      Events:
        ApiVendor:
          Type: Api
          Properties:
            Path: /vendor/{proxy+}
            Method: ANY
            Auth:
              Authorizer: NONE

  # CEOService: CEO dashboard, approvals, audit logs
  CEOService:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "TrustGuard-CEOService-${Environment}"
      CodeUri: ../../backend/
      Handler: app.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          ESCALATIONS_TABLE: !Ref TrustGuardEscalationsTable
          ORDERS_TABLE: !Ref TrustGuardOrdersTable
          USERS_TABLE: !Ref TrustGuardUsersTable
          AUDIT_LOGS_TABLE: !Ref TrustGuardAuditLogsTable
          OTPS_TABLE: !Ref TrustGuardOTPsTable
          CEO_CONFIG_TABLE: !Ref TrustGuardCEOConfigTable
      Events:
        ApiCEO:
          Type: Api
          Properties:
            Path: /ceo/{proxy+}
            Method: ANY
            Auth:
              Authorizer: NONE

  # OrderService: Order creation and lifecycle management
  OrderService:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "TrustGuard-OrderService-${Environment}"
      CodeUri: ../../backend/
      Handler: app.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          ORDERS_TABLE: !Ref TrustGuardOrdersTable
          USERS_TABLE: !Ref TrustGuardUsersTable
          JWT_SECRET_ARN: !Ref TrustGuardSecrets
          AUDIT_LOGS_TABLE: !Ref TrustGuardAuditLogsTable
          NEGOTIATIONS_TABLE: !Ref TrustGuardNegotiationsTable
      Events:
        ApiOrders:
          Type: Api
          Properties:
            Path: /orders/{proxy+}
            Method: ANY
            Auth:
              Authorizer: NONE
        ApiOrdersRoot:
          Type: Api
          Properties:
            Path: /orders
            Method: ANY
            Auth:
              Authorizer: NONE
        ApiNegotiations:
          Type: Api
          Properties:
            Path: /negotiations/{proxy+}
            Method: ANY
            Auth:
              Authorizer: NONE
        ApiNegotiationsRoot:
          Type: Api
          Properties:
            Path: /negotiations
            Method: ANY
            Auth:
              Authorizer: NONE

  # ReceiptService: Receipt upload and presigned URL generation
  ReceiptService:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "TrustGuard-ReceiptService-${Environment}"
      CodeUri: ../../backend/
      Handler: app.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          RECEIPT_BUCKET: !Ref TrustGuardReceiptBucket
          KMS_KEY_ID: !Ref TrustGuardKMSKey
          ORDERS_TABLE: !Ref TrustGuardOrdersTable
          AUDIT_LOGS_TABLE: !Ref TrustGuardAuditLogsTable
      Events:
        ApiReceipts:
          Type: Api
          Properties:
            Path: /receipts/{proxy+}
            Method: ANY
            Auth:
              Authorizer: NONE
        ApiReceiptsRoot:
          Type: Api
          Properties:
            Path: /receipts
            Method: ANY
            Auth:
              Authorizer: NONE

  # TokenRefreshFunction: Scheduled Meta OAuth token refresh
  TokenRefreshFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "TrustGuard-TokenRefresh-${Environment}"
      CodeUri: ../../backend/
      Handler: integrations.token_refresh.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300  # 5 minutes for multiple CEOs
      Environment:
        Variables:
          USERS_TABLE: !Ref TrustGuardUsersTable
          META_SECRET_NAME: !Sub "/TrustGuard/${Environment}/meta-${AWS::StackName}"
          MONITORING_ALERT_TOPIC_ARN: !Ref MonitoringAlertTopic
      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            Schedule: "cron(0 2 * * ? *)"  # 2 AM UTC daily
            Description: Daily Meta OAuth token refresh check
            Enabled: true

  # CloudWatch Alarm: Token Expiry Warning
  TokenExpiryAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlertEmail
    Properties:
      AlarmName: !Sub "TrustGuard-TokenExpiry-${Environment}"
      AlarmDescription: Alert when Meta OAuth tokens are expiring soon
      MetricName: DaysUntilTokenExpiry
      Namespace: TrustGuard/Tokens
      Statistic: Minimum
      Period: 86400  # 1 day
      EvaluationPeriods: 1
      Threshold: 3
      ComparisonOperator: LessThanThreshold
      TreatMissingData: breaching
      AlarmActions:
        - !Ref MonitoringAlertTopic

# ============================================================
# OUTPUTS: Key infrastructure details
# ============================================================
Outputs:
  APIEndpoint:
    Description: API Gateway endpoint URL
    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/"
    Export:
      Name: !Sub "TrustGuard-API-${Environment}"
  
  ReceiptBucket:
    Description: S3 bucket for encrypted receipts
    Value: !Ref TrustGuardReceiptBucket
    Export:
      Name: !Sub "TrustGuard-ReceiptBucket-${Environment}"
  
  KMSKeyId:
    Description: KMS key ID for encryption
    Value: !Ref TrustGuardKMSKey
    Export:
      Name: !Sub "TrustGuard-KMSKey-${Environment}"
  
  SecretsArn:
    Description: Secrets Manager ARN for app secrets (inject JWT_SECRET here)
    Value: !Ref TrustGuardSecrets
  
  MetaSecretsArn:
    Description: Secrets Manager ARN for Meta API secrets
    Value: !Ref TrustGuardMetaSecrets
  
  EscalationTopicArn:
    Description: SNS topic ARN for escalation alerts
    Value: !Ref EscalationAlertTopic
    Export:
      Name: !Sub "TrustGuard-EscalationTopic-${Environment}"
